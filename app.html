<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>USP Expedientes · App</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7fb;margin:0}
    .wrap{max-width:1100px;margin:20px auto;padding:16px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .card{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:14px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .col-2{grid-column:span 2}
    label{display:block;color:#6b7280;font-size:12px;margin:6px 0}
    input,select,textarea{width:100%;padding:9px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px}
    textarea{min-height:90px}
    .btn{padding:9px 12px;border:0;border-radius:10px;background:#4f46e5;color:#fff;font-weight:700;cursor:pointer}
    .btn2{padding:9px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-weight:700;cursor:pointer}
    .muted{color:#6b7280;font-size:12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-weight:700;font-size:13px}
    .tab.active{background:#4f46e5;color:#fff;border-color:#4f46e5}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:13px}
    th{color:#6b7280;font-weight:700}
    .ok{color:#166534;font-weight:700}
    .err{color:#b91c1c;font-weight:700}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f3f4f6;font-size:12px}
    .right{display:flex;gap:8px;align-items:center}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div style="font-weight:900;font-size:18px;">USP Expedientes</div>
        <div class="muted" id="who">Cargando sesión…</div>
      </div>
      <div class="right">
        <span class="pill" id="rolePill">ROL: …</span>
        <button class="btn2" id="logout">Cerrar sesión</button>
      </div>
    </div>

    <div class="card">
      <div class="tabs" id="tabs"></div>
    </div>

    <div style="height:12px"></div>

    <!-- ADMIN: Catálogos -->
    <div class="card hide" id="viewAdminCatalogs">
      <h3 style="margin:0 0 10px;">Catálogos (ADMIN)</h3>

      <div class="row">
        <div class="col-3">
          <label>Catálogo</label>
          <select id="catType">
            <option value="catalog_faculties">Facultades</option>
            <option value="catalog_programs">Programas</option>
            <option value="catalog_reasons">Motivos</option>
            <option value="catalog_referrals">Canalización</option>
            <option value="catalog_services">Servicios</option>
          </select>
        </div>

        <div class="col-3" id="facultyFilterWrap">
          <label>Facultad (para Programas)</label>
          <select id="facultyFilter"></select>
        </div>

        <div class="col-6">
          <label>Nuevo registro</label>
          <div style="display:flex;gap:8px;">
            <input id="catName" placeholder="Nombre" />
            <button class="btn" id="btnAddCat">Agregar</button>
          </div>
          <div class="muted">Tip: en Programas, selecciona Facultad antes de agregar.</div>
        </div>

        <div class="col-12">
          <div id="catMsg" class="muted"></div>
          <table>
            <thead>
              <tr>
                <th style="width:70px;">ID</th>
                <th>Nombre</th>
                <th style="width:110px;">Activo</th>
                <th style="width:180px;">Acciones</th>
              </tr>
            </thead>
            <tbody id="catTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PSICOLOGO: Expedientes -->
    <div class="card hide" id="viewPsico">
      <h3 style="margin:0 0 10px;">Expedientes</h3>

      <div class="row">
        <div class="col-12"><b>1) Registrar alumno + abrir expediente</b></div>

        <div class="col-3">
          <label>Matrícula</label>
          <input id="stMat" placeholder="Ej. 202312345" />
        </div>
        <div class="col-3">
          <label>Nombre</label>
          <input id="stFirst" placeholder="Nombre(s)" />
        </div>
        <div class="col-3">
          <label>Apellidos</label>
          <input id="stLast" placeholder="Apellidos" />
        </div>
        <div class="col-3">
          <label>Sexo</label>
          <select id="stSex">
            <option>Masculino</option>
            <option>Femenino</option>
            <option>No especificado</option>
          </select>
        </div>

        <div class="col-4">
          <label>Facultad</label>
          <select id="stFaculty"></select>
        </div>
        <div class="col-4">
          <label>Programa educativo</label>
          <select id="stProgram"></select>
        </div>
        <div class="col-4">
          <label>Motivo (inicial)</label>
          <select id="stReason"></select>
        </div>

        <div class="col-4">
          <label>Canalización (inicial)</label>
          <select id="stReferral"></select>
        </div>
        <div class="col-8" style="display:flex;align-items:flex-end;gap:10px;">
          <button class="btn" id="btnCreateCase">Crear expediente</button>
          <div id="psMsg" class="muted"></div>
        </div>

        <div class="col-12" style="margin-top:8px;"><b>2) Mis expedientes</b></div>
        <div class="col-12">
          <table>
            <thead>
              <tr>
                <th>Matrícula</th>
                <th>Alumno</th>
                <th>Facultad</th>
                <th>Programa</th>
                <th>Última actividad</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="casesTable"></tbody>
          </table>
        </div>

        <div class="col-12 hide" id="sessionPane">
          <hr style="border:none;border-top:1px solid #eee;margin:14px 0">
          <b>3) Agregar sesión</b>
          <div class="row">
            <div class="col-3">
              <label>Fecha de atención</label>
              <input id="seDate" type="date" />
            </div>
            <div class="col-3">
              <label>Servicio</label>
              <select id="seService"></select>
            </div>
            <div class="col-3">
              <label>Motivo</label>
              <select id="seReason"></select>
            </div>
            <div class="col-3">
              <label>Canalización</label>
              <select id="seReferral"></select>
            </div>
            <div class="col-12">
              <label>Nota</label>
              <textarea id="seNote" placeholder="Nota breve de sesión (sensible)"></textarea>
            </div>
            <div class="col-12" style="display:flex;gap:10px;align-items:center;">
              <button class="btn" id="btnAddSession">Guardar sesión</button>
              <span id="seMsg" class="muted"></span>
            </div>
          </div>

          <div style="height:10px"></div>
          <b>Sesiones recientes</b>
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Servicio</th>
                <th>Motivo</th>
                <th>Canalización</th>
                <th>Nota</th>
              </tr>
            </thead>
            <tbody id="sessionsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- JEFE: Estadísticas -->
    <div class="card hide" id="viewJefe">
      <h3 style="margin:0 0 10px;">Estadísticas</h3>
      <div class="row">
        <div class="col-3">
          <label>Facultad</label>
          <select id="stF"></select>
        </div>
        <div class="col-3">
          <label>Programa</label>
          <select id="stP"></select>
        </div>
        <div class="col-2">
          <label>k mínimo</label>
          <input id="stK" type="number" min="2" value="5"/>
        </div>
        <div class="col-4" style="display:flex;align-items:flex-end;gap:10px;">
          <button class="btn" id="btnLoadStats">Cargar</button>
          <span id="statsMsg" class="muted"></span>
        </div>

        <div class="col-12">
          <pre id="statsOut" style="background:#0b1020;color:#e5e7eb;padding:12px;border-radius:12px;overflow:auto;max-height:360px;"></pre>
          <div class="muted">Nota: el JEFE solo recibe agregados (sin matrículas ni nombres).</div>
        </div>
      </div>
    </div>

  </div>

  <script src="config.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const cfg = window.APP_CONFIG;
    const supabase = createClient(cfg.SUPABASE_URL, cfg.SUPABASE_PUBLISHABLE_KEY);

    const $ = (id)=>document.getElementById(id);
    const show = (el)=>el.classList.remove("hide");
    const hide = (el)=>el.classList.add("hide");
    const setMsg = (id, text, cls="muted") => { const el=$(id); el.className=cls; el.textContent=text; };

    // --- sesión ---
    const sessionRes = await supabase.auth.getSession();
    if(!sessionRes.data.session){
      window.location.href = new URL("index.html", cfg.SITE_URL).toString();
    }
    const user = sessionRes.data.session.user;
    $("who").textContent = `Sesión activa: ${user.email || ""}`;

    $("logout").onclick = async ()=>{
      await supabase.auth.signOut();
      window.location.href = new URL("index.html", cfg.SITE_URL).toString();
    };

    // --- perfil/rol + is_psicologo (OPCIÓN 1) ---
    const prof = await supabase
      .from("profiles")
      .select("role, full_name, is_psicologo")
      .eq("user_id", user.id)
      .single();

    const role = prof.data?.role || "PSICOLOGO";
    const isPsicologo = !!prof.data?.is_psicologo;

    $("rolePill").textContent = `ROL: ${role}${(role==="ADMIN" && isPsicologo) ? " + PSICOLOGO" : ""}`;

    // --- Tabs según rol/capacidad ---
    const tabs = [];
    if(role === "ADMIN"){ tabs.push({id:"adminCats", label:"Catálogos", view:"viewAdminCatalogs"}); }

    if(role === "PSICOLOGO" || (role === "ADMIN" && isPsicologo)){
      tabs.push({id:"psico", label:"Expedientes", view:"viewPsico"});
    }

    if(role === "JEFE" || role === "ADMIN"){
      tabs.push({id:"jefe", label:"Estadísticas", view:"viewJefe"});
    }

    function activateTab(tabId){
      [...document.querySelectorAll(".tab")].forEach(b=>b.classList.remove("active"));
      document.querySelector(`.tab[data-id="${tabId}"]`)?.classList.add("active");

      ["viewAdminCatalogs","viewPsico","viewJefe"].forEach(v=>hide($(v)));
      const t = tabs.find(x=>x.id===tabId);
      if(t) show($(t.view));
    }

    $("tabs").innerHTML = tabs.map(t=>`<button class="tab" data-id="${t.id}">${t.label}</button>`).join("");
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.onclick = ()=>activateTab(btn.dataset.id);
    });
    activateTab(tabs[0].id);

    // --- Helpers catálogos ---
    async function loadFaculties(selectEl, includeAll=true){
      const { data } = await supabase.from("catalog_faculties").select("id,name,active").order("name");
      selectEl.innerHTML = (includeAll ? `<option value="">(Todas)</option>` : ``) +
        (data||[]).map(x=>`<option value="${x.id}">${x.name}${x.active? "" : " (INACTIVA)"}</option>`).join("");
      return data||[];
    }
    async function loadPrograms(selectEl, facultyId, includeAll=true){
      let q = supabase.from("catalog_programs").select("id,name,active,faculty_id").order("name");
      if(facultyId) q = q.eq("faculty_id", facultyId);
      const { data } = await q;
      selectEl.innerHTML = (includeAll ? `<option value="">(Todos)</option>` : ``) +
        (data||[]).map(x=>`<option value="${x.id}">${x.name}${x.active? "" : " (INACTIVO)"}</option>`).join("");
      return data||[];
    }
    async function loadSimple(selectEl, table, includeAll=false){
      const { data } = await supabase.from(table).select("id,name,active").order("name");
      selectEl.innerHTML = (includeAll ? `<option value="">(Todos)</option>` : ``) +
        (data||[]).filter(x=>x.active).map(x=>`<option value="${x.id}">${x.name}</option>`).join("");
      return data||[];
    }
    const toISODate = (d)=> new Date(d).toISOString().slice(0,10);

    // =========================
    // ADMIN · Catálogos
    // =========================
    if(role === "ADMIN"){
      await loadFaculties($("facultyFilter"), true);
      $("facultyFilterWrap").style.display = "none";

      $("catType").onchange = async ()=>{
        const t = $("catType").value;
        $("facultyFilterWrap").style.display = (t==="catalog_programs") ? "block" : "none";
        if(t==="catalog_programs"){
          await loadFaculties($("facultyFilter"), true);
        }
        await refreshCatalogTable();
      };

      $("facultyFilter").onchange = async ()=>refreshCatalogTable();

      async function refreshCatalogTable(){
        const t = $("catType").value;
        setMsg("catMsg","Cargando…");
        let q = supabase.from(t).select("*").order("id");
        if(t==="catalog_programs"){
          const fid = $("facultyFilter").value || null;
          if(fid) q = q.eq("faculty_id", fid);
        }
        const { data, error } = await q;
        if(error){ setMsg("catMsg","Error: "+error.message,"err"); return; }

        setMsg("catMsg", `${data.length} registros.`);
        $("catTable").innerHTML = (data||[]).map(r=>{
          const active = r.active ? "Sí" : "No";
          return `
            <tr>
              <td>${r.id}</td>
              <td>${r.name ?? ""}</td>
              <td>${active}</td>
              <td>
                <button class="btn2" data-act="toggle" data-id="${r.id}">Act/Des</button>
                <button class="btn2" data-act="del" data-id="${r.id}">Borrar</button>
              </td>
            </tr>`;
        }).join("");

        $("catTable").querySelectorAll("button").forEach(b=>{
          b.onclick = async ()=>{
            const id = b.dataset.id;
            const act = b.dataset.act;
            if(act==="toggle"){
              const row = data.find(x=>String(x.id)===String(id));
              const { error } = await supabase.from(t).update({active: !row.active}).eq("id", id);
              if(error) setMsg("catMsg","Error: "+error.message,"err");
              else await refreshCatalogTable();
            }
            if(act==="del"){
              if(!confirm("¿Seguro que deseas borrar este registro?")) return;
              const { error } = await supabase.from(t).delete().eq("id", id);
              if(error) setMsg("catMsg","Error: "+error.message,"err");
              else await refreshCatalogTable();
            }
          };
        });
      }

      $("btnAddCat").onclick = async ()=>{
        const t = $("catType").value;
        const name = $("catName").value.trim();
        if(!name) return setMsg("catMsg","Escribe un nombre.","err");

        let payload = { name, active:true };
        if(t==="catalog_programs"){
          const fid = $("facultyFilter").value;
          if(!fid) return setMsg("catMsg","Selecciona una Facultad para agregar Programas.","err");
          payload = { ...payload, faculty_id: Number(fid) };
        }

        const { error } = await supabase.from(t).insert([payload]);
        if(error) setMsg("catMsg","Error: "+error.message,"err");
        else {
          $("catName").value="";
          await refreshCatalogTable();
        }
      };

      await refreshCatalogTable();
    }

    // =========================
    // PSICOLOGO (o ADMIN con is_psicologo)
    // =========================
    const canPsico = (role === "PSICOLOGO") || (role === "ADMIN" && isPsicologo);
    let selectedCaseId = null;

    async function refreshCases(){
      const { data, error } = await supabase
        .from("cases")
        .select("id,last_activity_at,students:student_id(matricula,first_name,last_name,faculty_id,program_id)")
        .order("last_activity_at",{ascending:false});

      if(error){ $("casesTable").innerHTML = `<tr><td colspan="6">Error: ${error.message}</td></tr>`; return; }

      const fac = await supabase.from("catalog_faculties").select("id,name");
      const prog = await supabase.from("catalog_programs").select("id,name");
      const facMap = new Map((fac.data||[]).map(x=>[x.id,x.name]));
      const progMap = new Map((prog.data||[]).map(x=>[x.id,x.name]));

      $("casesTable").innerHTML = (data||[]).map(r=>{
        const st = r.students;
        const alumno = `${st.first_name} ${st.last_name}`;
        return `
          <tr>
            <td>${st.matricula}</td>
            <td>${alumno}</td>
            <td>${facMap.get(st.faculty_id) || st.faculty_id}</td>
            <td>${progMap.get(st.program_id) || st.program_id}</td>
            <td>${new Date(r.last_activity_at).toLocaleString()}</td>
            <td><button class="btn2" data-id="${r.id}">Sesiones</button></td>
          </tr>`;
      }).join("");

      $("casesTable").querySelectorAll("button").forEach(b=>{
        b.onclick = async ()=>{
          selectedCaseId = b.dataset.id;
          show($("sessionPane"));
          $("seDate").value = toISODate(new Date());
          await refreshSessions();
          setMsg("seMsg", `Expediente seleccionado: ${selectedCaseId}`);
        };
      });
    }

    async function refreshSessions(){
      if(!selectedCaseId) return;
      const { data, error } = await supabase
        .from("sessions")
        .select("happened_at,note,service_id,reason_id,referral_id")
        .eq("case_id", selectedCaseId)
        .order("happened_at",{ascending:false})
        .limit(20);

      if(error){ $("sessionsTable").innerHTML = `<tr><td colspan="5">Error: ${error.message}</td></tr>`; return; }

      const [svc, rea, ref] = await Promise.all([
        supabase.from("catalog_services").select("id,name"),
        supabase.from("catalog_reasons").select("id,name"),
        supabase.from("catalog_referrals").select("id,name")
      ]);
      const svcMap = new Map((svc.data||[]).map(x=>[x.id,x.name]));
      const reaMap = new Map((rea.data||[]).map(x=>[x.id,x.name]));
      const refMap = new Map((ref.data||[]).map(x=>[x.id,x.name]));

      $("sessionsTable").innerHTML = (data||[]).map(s=>{
        return `
          <tr>
            <td>${new Date(s.happened_at).toLocaleDateString()}</td>
            <td>${svcMap.get(s.service_id) || ""}</td>
            <td>${reaMap.get(s.reason_id) || ""}</td>
            <td>${refMap.get(s.referral_id) || ""}</td>
            <td>${(s.note||"").slice(0,120)}</td>
          </tr>`;
      }).join("") || `<tr><td colspan="5">Sin sesiones todavía.</td></tr>`;
    }

    if(canPsico){
      await loadFaculties($("stFaculty"), false);
      await loadPrograms($("stProgram"), $("stFaculty").value, false);
      await loadSimple($("stReason"), "catalog_reasons", false);
      await loadSimple($("stReferral"), "catalog_referrals", false);

      await loadSimple($("seService"), "catalog_services", false);
      await loadSimple($("seReason"), "catalog_reasons", false);
      await loadSimple($("seReferral"), "catalog_referrals", false);

      $("stFaculty").onchange = async ()=>{
        await loadPrograms($("stProgram"), $("stFaculty").value, false);
      };

      $("btnCreateCase").onclick = async ()=>{
        setMsg("psMsg","Guardando…");
        const matricula = $("stMat").value.trim();
        const first_name = $("stFirst").value.trim();
        const last_name = $("stLast").value.trim();
        const sex = $("stSex").value;
        const faculty_id = Number($("stFaculty").value);
        const program_id = Number($("stProgram").value);
        const initial_reason_id = Number($("stReason").value || 0) || null;
        const initial_referral_id = Number($("stReferral").value || 0) || null;

        if(!matricula || !first_name || !last_name) return setMsg("psMsg","Completa matrícula, nombre y apellidos.","err");
        if(!faculty_id || !program_id) return setMsg("psMsg","Selecciona facultad y programa.","err");

        let studentId = null;
        const existing = await supabase.from("students").select("id").eq("matricula", matricula).maybeSingle();
        if(existing.data?.id){
          studentId = existing.data.id;
          await supabase.from("students").update({first_name,last_name,sex,faculty_id,program_id}).eq("id", studentId);
        }else{
          const ins = await supabase.from("students").insert([{matricula,first_name,last_name,sex,faculty_id,program_id}]).select("id").single();
          if(ins.error) return setMsg("psMsg","Error student: "+ins.error.message,"err");
          studentId = ins.data.id;
        }

        const cs = await supabase.from("cases").insert([{
          student_id: studentId,
          responsable_user_id: user.id,
          initial_reason_id,
          initial_referral_id
        }]).select("id").single();

        if(cs.error) return setMsg("psMsg","Error case: "+cs.error.message,"err");

        setMsg("psMsg","✅ Expediente creado.","ok");
        await refreshCases();
      };

      $("btnAddSession").onclick = async ()=>{
        if(!selectedCaseId) return setMsg("seMsg","Selecciona un expediente primero.","err");

        const happened_at = $("seDate").value
          ? new Date($("seDate").value+"T12:00:00").toISOString()
          : new Date().toISOString();

        const service_id = Number($("seService").value || 0) || null;
        const reason_id = Number($("seReason").value || 0) || null;
        const referral_id = Number($("seReferral").value || 0) || null;
        const note = $("seNote").value.trim();

        setMsg("seMsg","Guardando…");

        const res = await supabase.from("sessions").insert([{
          case_id: selectedCaseId,
          happened_at,
          service_id,
          reason_id,
          referral_id,
          note,
          created_by: user.id
        }]);

        if(res.error) return setMsg("seMsg","Error: "+res.error.message,"err");

        $("seNote").value="";
        setMsg("seMsg","✅ Sesión guardada.","ok");
        await refreshSessions();
        await refreshCases();
      };

      await refreshCases();
    }

    // =========================
    // Estadísticas (JEFE o ADMIN)
    // =========================
    if(role === "JEFE" || role === "ADMIN"){
      await loadFaculties($("stF"), true);
      await loadPrograms($("stP"), null, true);

      $("stF").onchange = async ()=>{
        const fid = $("stF").value || null;
        await loadPrograms($("stP"), fid, true);
      };

      $("btnLoadStats").onclick = async ()=>{
        setMsg("statsMsg","Cargando…");
        const faculty = $("stF").value ? Number($("stF").value) : null;
        const program = $("stP").value ? Number($("stP").value) : null;
        const k = Number($("stK").value || 5);

        const { data, error } = await supabase.rpc("get_stats", {
          p_faculty_id: faculty,
          p_program_id: program,
          p_min_k: k
        });

        if(error){
          setMsg("statsMsg","Error: "+error.message,"err");
          $("statsOut").textContent = "";
          return;
        }
        setMsg("statsMsg","✅ Listo.","ok");
        $("statsOut").textContent = JSON.stringify(data, null, 2);
      };
    }
  </script>
</body>
</html>
